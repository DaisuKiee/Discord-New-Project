<!DOCTYPE html>
<html lang="en">
<head>
    <%- include('../partials/layout-head') %>
    <title>Modules - <%= guildName %></title>
    <style>
        .module-commands {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--border);
        }
        .module-commands-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.375rem;
            margin-top: 0.5rem;
        }
        .command-tag {
            font-size: 0.7rem;
            padding: 0.25rem 0.5rem;
            background: rgba(139, 92, 246, 0.15);
            border-radius: 4px;
            color: var(--primary-light);
            font-family: monospace;
        }
        .module-card.enabled {
            border-color: rgba(16, 185, 129, 0.5);
        }
        .module-card.enabled::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--success), var(--primary));
            border-radius: 16px 16px 0 0;
        }
        .expand-btn {
            background: none;
            border: none;
            color: var(--primary-light);
            font-size: 0.8rem;
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            transition: all 0.2s;
        }
        .expand-btn:hover {
            background: rgba(139, 92, 246, 0.1);
        }
        .commands-expanded {
            display: none;
        }
        .commands-expanded.show {
            display: flex;
        }
    </style>
</head>
<body>
    <%- include('../partials/loading', { loadingText: 'Loading modules...' }) %>
    
    <div class="page-wrapper">
        <%- include('../partials/dashboard-nav', { user }) %>
        
        <div class="dashboard-layout">
            <%- include('../partials/sidebar', { guildId, guildName, guildIcon: typeof guildIcon !== 'undefined' ? guildIcon : null, activePage: 'modules' }) %>
            
            <main class="main-content">
                <!-- Page Header -->
                <div class="page-header slide-up">
                    <div class="breadcrumb">
                        <a href="/dashboard">Dashboard</a>
                        <span>/</span>
                        <a href="/dashboard/guild/<%= guildId %>"><%= guildName %></a>
                        <span>/</span>
                        <span>Modules</span>
                    </div>
                    <h1><i class="fas fa-puzzle-piece" style="color: var(--primary);"></i> Module Management</h1>
                    <p>Enable or disable bot features for your server. Changes are saved automatically.</p>
                </div>

                <!-- Info Banner -->
                <div class="slide-up" style="animation-delay: 0.1s; background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(139, 92, 246, 0.05)); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 12px; padding: 1rem 1.25rem; margin-bottom: 2rem; display: flex; align-items: center; gap: 1rem;">
                    <i class="fas fa-info-circle" style="color: #3b82f6; font-size: 1.25rem;"></i>
                    <div>
                        <strong>Pro Tip:</strong> Only enable modules you need. This keeps your bot fast and your commands list clean!
                    </div>
                </div>

                <!-- Modules Grid -->
                <div class="grid-3 stagger">
                    <% 
                    const moduleConfig = {
                        'moderation': { icon: 'fa-shield-alt', color: 'rgba(239, 68, 68, 0.2)', iconColor: 'var(--danger)', title: 'Moderation', desc: 'Ban, kick, mute, warn members and track moderation cases with detailed logs.' },
                        'music': { icon: 'fa-music', color: 'rgba(168, 85, 247, 0.2)', iconColor: '#a855f7', title: 'Music Player', desc: 'Play music from YouTube, Spotify, SoundCloud with queue, filters, and controls.' },
                        'ai': { icon: 'fa-brain', color: 'rgba(139, 92, 246, 0.2)', iconColor: 'var(--primary-light)', title: 'AI Assistant', desc: 'Chat with AI and generate images using advanced AI models.' },
                        'utility': { icon: 'fa-tools', color: 'rgba(34, 197, 94, 0.2)', iconColor: '#22c55e', title: 'Utility', desc: 'Server info, user info, avatar, and other useful tools.' },
                        'config': { icon: 'fa-cog', color: 'rgba(59, 130, 246, 0.2)', iconColor: '#3b82f6', title: 'Configuration', desc: 'Configure bot settings like prefix and server preferences.' },
                        'dev': { icon: 'fa-code', color: 'rgba(245, 158, 11, 0.2)', iconColor: 'var(--warning)', title: 'Developer', desc: 'Developer-only commands for bot management.' }
                    };
                    
                    if (typeof commandCategories !== 'undefined' && commandCategories.length > 0) {
                        commandCategories.forEach((category, index) => {
                            // Skip dev category for non-developers
                            if (category.name === 'dev') return;
                            
                            const config = moduleConfig[category.name] || { 
                                icon: 'fa-puzzle-piece', 
                                color: 'rgba(139, 92, 246, 0.2)', 
                                iconColor: 'var(--primary-light)',
                                title: category.name.charAt(0).toUpperCase() + category.name.slice(1),
                                desc: `Commands for ${category.name} features.`
                            };
                            const isEnabled = modules[category.name] !== false;
                    %>
                    <div class="card module-card <%= isEnabled ? 'enabled' : '' %>" data-module="<%= category.name %>" style="position: relative;">
                        <div class="card-body">
                            <div class="module-header">
                                <div class="card-icon" style="background: <%= config.color %>; margin-bottom: 0;">
                                    <i class="fas <%= config.icon %>" style="color: <%= config.iconColor %>;"></i>
                                </div>
                                <label class="toggle">
                                    <input type="checkbox" class="module-toggle" data-module="<%= category.name %>" <%= isEnabled ? 'checked' : '' %>>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <h3 class="card-title"><%= config.title %></h3>
                            <p class="card-desc"><%= config.desc %></p>
                            <div class="module-commands">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-size: 0.8rem; color: var(--text-dim);">
                                        <i class="fas fa-terminal"></i> <%= category.commandCount %> command<%= category.commandCount !== 1 ? 's' : '' %>
                                    </span>
                                    <button class="expand-btn" onclick="toggleCommands(this)">
                                        <i class="fas fa-chevron-down"></i> View
                                    </button>
                                </div>
                                <div class="module-commands-list commands-expanded">
                                    <% category.commands.forEach(cmd => { %>
                                    <span class="command-tag">/<%= cmd %></span>
                                    <% }); %>
                                </div>
                            </div>
                        </div>
                    </div>
                    <% 
                        });
                    }
                    %>
                    
                    <!-- Tickets Module - Dashboard Configured -->
                    <div class="card module-card <%= modules.tickets !== false ? 'enabled' : '' %>" data-module="tickets" style="position: relative;">
                        <div class="card-body">
                            <div class="module-header">
                                <div class="card-icon" style="background: rgba(236, 72, 153, 0.2); margin-bottom: 0;">
                                    <i class="fas fa-ticket-alt" style="color: #ec4899;"></i>
                                </div>
                                <label class="toggle">
                                    <input type="checkbox" class="module-toggle" data-module="tickets" <%= modules.tickets !== false ? 'checked' : '' %>>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <h3 class="card-title">Ticket System</h3>
                            <p class="card-desc">Support tickets with categories, panels, claiming, and HTML transcripts.</p>
                            <div class="module-commands">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-size: 0.8rem; color: var(--text-dim);">
                                        <i class="fas fa-sliders-h"></i> Dashboard configured
                                    </span>
                                    <a href="/dashboard/guild/<%= guildId %>/tickets" class="expand-btn" style="text-decoration: none;">
                                        <i class="fas fa-cog"></i> Setup
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Welcome Module - Dashboard Configured -->
                    <div class="card module-card <%= modules.welcome !== false ? 'enabled' : '' %>" data-module="welcome" style="position: relative;">
                        <div class="card-body">
                            <div class="module-header">
                                <div class="card-icon" style="background: rgba(59, 130, 246, 0.2); margin-bottom: 0;">
                                    <i class="fas fa-hand-wave" style="color: #3b82f6;"></i>
                                </div>
                                <label class="toggle">
                                    <input type="checkbox" class="module-toggle" data-module="welcome" <%= modules.welcome !== false ? 'checked' : '' %>>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <h3 class="card-title">Welcome Messages</h3>
                            <p class="card-desc">Greet new members with custom messages, embeds, and auto-roles.</p>
                            <div class="module-commands">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-size: 0.8rem; color: var(--text-dim);">
                                        <i class="fas fa-sliders-h"></i> Dashboard configured
                                    </span>
                                    <a href="/dashboard/guild/<%= guildId %>/welcome" class="expand-btn" style="text-decoration: none;">
                                        <i class="fas fa-cog"></i> Setup
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <% if (typeof commandCategories === 'undefined' || commandCategories.length === 0) { %>
                    <!-- Fallback if no categories found -->
                    <div class="card" style="grid-column: 1 / -1; text-align: center; padding: 3rem;">
                        <i class="fas fa-puzzle-piece" style="font-size: 3rem; color: var(--text-dim); margin-bottom: 1rem;"></i>
                        <h3>No Command Modules Found</h3>
                        <p style="color: var(--text-muted);">Unable to load command modules. Dashboard modules are still available above.</p>
                    </div>
                    <% } %>
                </div>
            </main>
        </div>
    </div>

    <script src="/js/dashboard.js"></script>
    <script>
        const guildId = '<%= guildId %>';
        
        function toggleCommands(btn) {
            const commandsList = btn.parentElement.nextElementSibling;
            const icon = btn.querySelector('i');
            
            if (commandsList.classList.contains('show')) {
                commandsList.classList.remove('show');
                icon.classList.remove('fa-chevron-up');
                icon.classList.add('fa-chevron-down');
                btn.innerHTML = '<i class="fas fa-chevron-down"></i> View';
            } else {
                commandsList.classList.add('show');
                icon.classList.remove('fa-chevron-down');
                icon.classList.add('fa-chevron-up');
                btn.innerHTML = '<i class="fas fa-chevron-up"></i> Hide';
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            initModuleToggles(guildId);
        });
    </script>
</body>
</html>
