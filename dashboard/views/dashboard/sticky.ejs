<!DOCTYPE html>
<html lang="en">
<head>
    <%- include('../partials/layout-head') %>
    <title>Sticky Messages - <%= guildName %></title>
</head>
<body>
    <%- include('../partials/loading', { loadingText: 'Loading sticky messages...' }) %>
    
    <div class="page-wrapper">
        <%- include('../partials/dashboard-nav', { user }) %>
        
        <div class="dashboard-layout">
            <%- include('../partials/sidebar', { guildId, guildName, guildIcon: typeof guildIcon !== 'undefined' ? guildIcon : null, activePage: 'sticky' }) %>
            
            <main class="main-content">
                <!-- Page Header -->
                <div class="page-header slide-up">
                    <div class="breadcrumb">
                        <a href="/dashboard">Dashboard</a>
                        <span>/</span>
                        <a href="/dashboard/guild/<%= guildId %>"><%= guildName %></a>
                        <span>/</span>
                        <span>Sticky Messages</span>
                    </div>
                    <h1><i class="fas fa-thumbtack" style="color: #a855f7;"></i> Sticky Messages</h1>
                    <p>Keep important messages pinned at the bottom of channels</p>
                </div>

                <!-- Info Banner -->
                <div class="card slide-up" style="animation-delay: 0.1s; margin-bottom: 2rem; background: linear-gradient(135deg, rgba(168, 85, 247, 0.1), rgba(139, 92, 246, 0.05));">
                    <div class="card-body">
                        <div style="display: flex; align-items: flex-start; gap: 1rem;">
                            <div style="width: 40px; height: 40px; border-radius: 10px; background: rgba(168, 85, 247, 0.2); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                <i class="fas fa-info-circle" style="color: #a855f7;"></i>
                            </div>
                            <div>
                                <strong>How Sticky Messages Work</strong>
                                <p style="color: var(--text-muted); font-size: 0.9rem; margin-top: 0.25rem;">
                                    Sticky messages automatically repost themselves when new messages are sent in the channel, 
                                    keeping important information always visible at the bottom.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid-2" style="gap: 2rem;">
                    <!-- Create New Sticky -->
                    <div class="card slide-up" style="animation-delay: 0.2s;">
                        <div class="card-body">
                            <h3 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-plus-circle" style="color: var(--success);"></i>
                                Create Sticky Message
                            </h3>
                            
                            <div class="form-group">
                                <label class="form-label">Channel</label>
                                <select id="stickyChannel" class="form-select">
                                    <option value="">Select a channel...</option>
                                    <% if (typeof channels !== 'undefined') { %>
                                        <% channels.forEach(channel => { %>
                                            <option value="<%= channel.id %>">#<%= channel.name %></option>
                                        <% }); %>
                                    <% } %>
                                </select>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Message Content</label>
                                <textarea id="stickyContent" class="form-textarea" rows="5" placeholder="Enter your sticky message content..."></textarea>
                                <p class="form-hint">Supports Discord markdown formatting</p>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Embed Color (optional)</label>
                                <div style="display: flex; gap: 1rem; align-items: center;">
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                        <input type="checkbox" id="useEmbed" style="width: 18px; height: 18px;">
                                        <span>Use embed</span>
                                    </label>
                                    <input type="color" id="embedColor" value="#a855f7" style="width: 50px; height: 35px; border: none; border-radius: 6px; cursor: pointer;" disabled>
                                </div>
                            </div>

                            <button id="createStickyBtn" class="btn btn-primary" style="width: 100%;">
                                <i class="fas fa-thumbtack"></i> Create Sticky Message
                            </button>
                        </div>
                    </div>

                    <!-- Preview -->
                    <div class="card slide-up" style="animation-delay: 0.3s;">
                        <div class="card-body">
                            <h3 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-eye" style="color: var(--primary);"></i>
                                Preview
                            </h3>
                            <div id="stickyPreview" style="background: #36393f; border-radius: 8px; padding: 1rem; min-height: 150px;">
                                <p style="color: #72767d; text-align: center;">Enter a message to see preview</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Active Sticky Messages -->
                <div class="card slide-up" style="animation-delay: 0.4s; margin-top: 2rem;">
                    <div class="card-body">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                            <h3 style="font-size: 1.25rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-list" style="color: var(--warning);"></i>
                                Active Sticky Messages
                            </h3>
                            <span style="padding: 0.25rem 0.75rem; background: rgba(139, 92, 246, 0.2); border-radius: 20px; font-size: 0.85rem;">
                                <span id="stickyCount"><%= typeof stickies !== 'undefined' ? stickies.length : 0 %></span> active
                            </span>
                        </div>

                        <div id="stickyList">
                            <% if (typeof stickies === 'undefined' || stickies.length === 0) { %>
                                <div class="empty-state" style="padding: 2rem;">
                                    <i class="fas fa-thumbtack" style="font-size: 3rem; color: var(--text-dim);"></i>
                                    <h3 style="margin-top: 1rem;">No Sticky Messages</h3>
                                    <p style="color: var(--text-muted);">Create your first sticky message above to get started.</p>
                                </div>
                            <% } else { %>
                                <% stickies.forEach(sticky => { %>
                                    <div class="sticky-item" style="display: flex; align-items: flex-start; gap: 1rem; padding: 1.25rem; background: rgba(139, 92, 246, 0.05); border-radius: 12px; margin-bottom: 1rem; border: 1px solid var(--border);">
                                        <div style="width: 44px; height: 44px; border-radius: 10px; background: rgba(168, 85, 247, 0.2); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                            <i class="fas fa-thumbtack" style="color: #a855f7;"></i>
                                        </div>
                                        <div style="flex: 1; min-width: 0;">
                                            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                                                <span style="font-weight: 600; color: var(--primary-light);">#<%= sticky.channelName %></span>
                                                <span style="padding: 0.2rem 0.5rem; background: rgba(16, 185, 129, 0.2); color: var(--success); font-size: 0.75rem; border-radius: 4px;">Active</span>
                                            </div>
                                            <p style="color: var(--text-muted); font-size: 0.9rem; white-space: pre-wrap; word-break: break-word;"><%= sticky.content.length > 200 ? sticky.content.substring(0, 200) + '...' : sticky.content %></p>
                                        </div>
                                        <div style="display: flex; gap: 0.5rem; flex-shrink: 0;">
                                            <button class="btn btn-secondary btn-sm edit-sticky" data-channel="<%= sticky.channelId %>" data-content="<%= sticky.content %>">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-danger btn-sm delete-sticky" data-channel="<%= sticky.channelId %>">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                <% }); %>
                            <% } %>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script src="/js/dashboard.js"></script>
    <script>
        const guildId = '<%= guildId %>';

        // Toggle embed color picker
        document.getElementById('useEmbed').addEventListener('change', (e) => {
            document.getElementById('embedColor').disabled = !e.target.checked;
            updatePreview();
        });

        // Live preview
        document.getElementById('stickyContent').addEventListener('input', updatePreview);
        document.getElementById('embedColor').addEventListener('input', updatePreview);

        function updatePreview() {
            const content = document.getElementById('stickyContent').value;
            const useEmbed = document.getElementById('useEmbed').checked;
            const color = document.getElementById('embedColor').value;
            const preview = document.getElementById('stickyPreview');

            if (!content) {
                preview.innerHTML = '<p style="color: #72767d; text-align: center;">Enter a message to see preview</p>';
                return;
            }

            if (useEmbed) {
                preview.innerHTML = `
                    <div style="border-left: 4px solid ${color}; padding-left: 12px; background: #2f3136; border-radius: 4px; padding: 12px;">
                        <p style="color: #dcddde; white-space: pre-wrap;">${escapeHtml(content)}</p>
                    </div>
                `;
            } else {
                preview.innerHTML = `<p style="color: #dcddde; white-space: pre-wrap;">${escapeHtml(content)}</p>`;
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Create sticky
        document.getElementById('createStickyBtn').addEventListener('click', async () => {
            const channelId = document.getElementById('stickyChannel').value;
            const content = document.getElementById('stickyContent').value;
            const useEmbed = document.getElementById('useEmbed').checked;
            const embedColor = document.getElementById('embedColor').value;

            if (!channelId) {
                Toast.error('Please select a channel');
                return;
            }

            if (!content.trim()) {
                Toast.error('Please enter message content');
                return;
            }

            try {
                const response = await fetch(`/api/guild/${guildId}/sticky`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        channelId, 
                        content,
                        useEmbed,
                        embedColor
                    })
                });

                if (response.ok) {
                    Toast.success('Sticky message created!');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    const data = await response.json();
                    throw new Error(data.error || 'Failed to create');
                }
            } catch (error) {
                Toast.error(error.message || 'Failed to create sticky message');
            }
        });

        // Edit sticky
        document.querySelectorAll('.edit-sticky').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const channelId = e.currentTarget.dataset.channel;
                const content = e.currentTarget.dataset.content;
                
                // Find the channel option and select it
                const channelSelect = document.getElementById('stickyChannel');
                channelSelect.value = channelId;
                
                // Set the content
                document.getElementById('stickyContent').value = content;
                
                // Update preview
                updatePreview();
                
                // Scroll to form
                document.querySelector('.page-header').scrollIntoView({ behavior: 'smooth' });
                
                Toast.success('Editing sticky message - make changes and click Create to update');
            });
        });

        // Delete sticky
        document.querySelectorAll('.delete-sticky').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                const channelId = e.currentTarget.dataset.channel;
                
                if (!confirm('Are you sure you want to delete this sticky message?')) return;

                try {
                    const response = await fetch(`/api/guild/${guildId}/sticky/${channelId}`, {
                        method: 'DELETE'
                    });

                    if (response.ok) {
                        Toast.success('Sticky message deleted!');
                        e.currentTarget.closest('.sticky-item').remove();
                        
                        // Update count
                        const countEl = document.getElementById('stickyCount');
                        countEl.textContent = parseInt(countEl.textContent) - 1;
                        
                        // Show empty state if no more stickies
                        if (parseInt(countEl.textContent) === 0) {
                            document.getElementById('stickyList').innerHTML = `
                                <div class="empty-state" style="padding: 2rem;">
                                    <i class="fas fa-thumbtack" style="font-size: 3rem; color: var(--text-dim);"></i>
                                    <h3 style="margin-top: 1rem;">No Sticky Messages</h3>
                                    <p style="color: var(--text-muted);">Create your first sticky message above to get started.</p>
                                </div>
                            `;
                        }
                    } else {
                        throw new Error('Failed to delete');
                    }
                } catch (error) {
                    Toast.error('Failed to delete sticky message');
                }
            });
        });
    </script>
</body>
</html>
